import TileGrid from"../tilegrid/TileGrid.js";import{getJSON,resolveUrl}from"../net.js";import{get as getProjection}from"../proj.js";import{getIntersection as intersectExtents}from"../extent.js";const knownMapMediaTypes={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},knownVectorMediaTypes={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function getMapTileUrlTemplate(t,i){let r,l;for(let e=0;e<t.length;++e){const n=t[e];if("item"===n.rel){if(n.type===i){r=n.href;break}(knownMapMediaTypes[n.type]||!l&&n.type.startsWith("image/"))&&(l=n.href)}}if(!r){if(!l)throw new Error('Could not find "item" link');r=l}return r}function getVectorTileUrlTemplate(t,i,r){let l,n;const o={};for(let e=0;e<t.length;++e){var a=t[e];if(o[a.type]=a.href,"item"===a.rel){if(a.type===i){l=a.href;break}knownVectorMediaTypes[a.type]&&(n=a.href)}}if(!l&&r)for(let e=0;e<r.length;++e){var s=r[e];if(o[s]){l=o[s];break}}if(!l){if(!n)throw new Error('Could not find "item" link');l=n}return l}function parseTileMatrixSet(e,t,a,s){let i=e.projection;if(!i&&!(i=getProjection(t.crs)))throw new Error("Unsupported CRS: "+t.crs);const r=t.orderedAxes;var l="en"!==(r?r.slice(0,2).map(e=>e.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):i.getAxisOrientation().substr(0,2)),n=t.tileMatrices;const p={};for(let e=0;e<n.length;++e){var o=n[e];p[o.id]=o}const f={},c=[];if(s)for(let e=0;e<s.length;++e){var g=s[e],m=g.tileMatrix;c.push(m),f[m]=g}else for(let e=0;e<n.length;++e){var T=n[e].id;c.push(T)}var d=c.length;const w=new Array(d),u=new Array(d),h=new Array(d),x=new Array(d);var M=[-1/0,-1/0,1/0,1/0];for(let i=0;i<d;++i){var y=c[i],v=p[y],S=v.pointOfOrigin,S=(w[i]=l?[S[1],S[0]]:S,u[i]=v.cellSize,h[i]=[v.matrixWidth,v.matrixHeight],x[i]=[v.tileWidth,v.tileHeight],f[y]);if(S){var y=v.cellSize*v.tileWidth,k=w[i][0]+S.minTileCol*y,y=w[i][0]+(S.maxTileCol+1)*y,j=v.cellSize*v.tileHeight,v="bottomLeft"===v.cornerOfOrigin;let e,t;t=v?(e=w[i][1]+S.minTileRow*j,w[i][1]+(S.maxTileRow+1)*j):(e=w[i][1]-(S.maxTileRow+1)*j,w[i][1]-S.minTileRow*j),intersectExtents(M,[k,e,y,t],M)}}t=new TileGrid({origins:w,resolutions:u,sizes:h,tileSizes:x,extent:s?M:void 0});const O=e.context,b=e.url;return{grid:t,urlTemplate:a,urlFunction:function(e,t,i){if(e){var r=c[e[0]],l=p[r],n="bottomLeft"===l.cornerOfOrigin;const o={tileMatrix:r,tileCol:e[1],tileRow:n?-e[2]-1:e[2]};if(s){r=f[l.id];if(o.tileCol<r.minTileCol||o.tileCol>r.maxTileCol||o.tileRow<r.minTileRow||o.tileRow>r.maxTileRow)return}Object.assign(o,O);n=a.replace(/\{(\w+?)\}/g,function(e,t){return o[t]});return resolveUrl(b,n)}}}}function parseTileSetMetadata(t,e){const i=e.tileMatrixSetLimits;let r;if("map"===e.dataType)r=getMapTileUrlTemplate(e.links,t.mediaType);else{if("vector"!==e.dataType)throw new Error('Expected tileset data type to be "map" or "vector"');r=getVectorTileUrlTemplate(e.links,t.mediaType,t.supportedMediaTypes)}if(e.tileMatrixSet)return parseTileMatrixSet(t,e.tileMatrixSet,r,i);e=e.links.find(e=>"http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme"===e.rel);if(!e)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");e=e.href,e=resolveUrl(t.url,e);return getJSON(e).then(function(e){return parseTileMatrixSet(t,e,r,i)})}function getTileSetInfo(t){return getJSON(t.url).then(function(e){return parseTileSetMetadata(t,e)})}export{getMapTileUrlTemplate,getVectorTileUrlTemplate,getTileSetInfo};