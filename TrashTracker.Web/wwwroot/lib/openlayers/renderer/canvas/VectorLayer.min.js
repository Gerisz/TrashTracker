import CanvasBuilderGroup from"../../render/canvas/BuilderGroup.js";import CanvasLayerRenderer,{canvasPool}from"./Layer.js";import ExecutorGroup,{ALL,DECLUTTER,NON_DECLUTTER}from"../../render/canvas/ExecutorGroup.js";import RenderEventType from"../../render/EventType.js";import ViewHint from"../../ViewHint.js";import{HIT_DETECT_RESOLUTION,createHitDetectionImageData,hitDetect}from"../../render/canvas/hitdetect.js";import{apply,makeInverse,makeScale,toString as transformToString}from"../../transform.js";import{buffer,containsExtent,createEmpty,getWidth,intersects as intersectsExtent,wrapX as wrapExtentX}from"../../extent.js";import{createCanvasContext2D,releaseCanvas}from"../../dom.js";import{defaultOrder as defaultRenderOrder,getTolerance as getRenderTolerance,getSquaredTolerance as getSquaredRenderTolerance,renderFeature}from"../vector.js";import{equals}from"../../array.js";import{fromUserExtent,getTransformFromProjections,getUserProjection,toUserExtent,toUserResolution}from"../../proj.js";import{getUid}from"../../util.js";import{wrapX as wrapCoordinateX}from"../../coordinate.js";class CanvasVectorLayerRenderer extends CanvasLayerRenderer{constructor(e){super(e),this.boundHandleStyleImageChange_=this.handleStyleImageChange_.bind(this),this.animatingOrInteracting_,this.hitDetectionImageData_=null,this.renderedFeatures_=null,this.renderedRevision_=-1,this.renderedResolution_=NaN,this.renderedExtent_=createEmpty(),this.wrappedRenderedExtent_=createEmpty(),this.renderedRotation_,this.renderedCenter_=null,this.renderedProjection_=null,this.renderedPixelRatio_=1,this.renderedRenderOrder_=null,this.replayGroup_=null,this.replayGroupChanged=!0,this.clipping=!0,this.compositionContext_=null,this.opacity_=1}renderWorlds(e,t,r){var n=t.extent,i=t.viewState,a=i.center,s=i.resolution;const o=i.projection;var d=i.rotation,i=o.getExtent();const h=this.getLayer().getSource();var l=this.getLayer().getDeclutter(),c=t.pixelRatio,p=t.viewHints,u=!(p[ViewHint.ANIMATING]||p[ViewHint.INTERACTING]),g=this.compositionContext_,m=Math.round(t.size[0]*c),_=Math.round(t.size[1]*c),p=h.getWrapX()&&o.canWrapX(),x=p?getWidth(i):null,f=p?Math.ceil((n[2]-i[2])/x)+1:1;let v=p?Math.floor((n[0]-i[0])/x):0;do{var E=this.getRenderTransform(a,s,d,c,m,_,v*x);e.execute(g,[g.canvas.width,g.canvas.height],E,d,u,void 0===r?ALL:r?DECLUTTER:NON_DECLUTTER,r?l&&t.declutter[l]:void 0)}while(++v<f)}setupCompositionContext_(){var e;1!==this.opacity_?(e=createCanvasContext2D(this.context.canvas.width,this.context.canvas.height,canvasPool),this.compositionContext_=e):this.compositionContext_=this.context}releaseCompositionContext_(){var e;1!==this.opacity_&&(e=this.context.globalAlpha,this.context.globalAlpha=this.opacity_,this.context.drawImage(this.compositionContext_.canvas,0,0),this.context.globalAlpha=e,releaseCanvas(this.compositionContext_),canvasPool.push(this.compositionContext_.canvas),this.compositionContext_=null)}renderDeclutter(e){this.getLayer().getDeclutter()&&(this.setupCompositionContext_(),this.renderWorlds(this.replayGroup_,e,!0),this.releaseCompositionContext_())}renderDeferredInternal(e){this.replayGroup_.renderDeferred()}renderFrame(e,t){var r=e.pixelRatio,n=e.layerStatesArray[e.layerIndex],i=(makeScale(this.pixelTransform,1/r,1/r),makeInverse(this.inversePixelTransform,this.pixelTransform),transformToString(this.pixelTransform));this.useContainer(t,i,this.getBackground(e));const a=this.context,s=a.canvas,o=this.replayGroup_;let d=o&&!o.isEmpty();if(!d&&!(this.getLayer().hasListener(RenderEventType.PRERENDER)||this.getLayer().hasListener(RenderEventType.POSTRENDER)))return null;var t=Math.round(e.size[0]*r),r=Math.round(e.size[1]*r),i=(s.width!=t||s.height!=r?(s.width=t,s.height=r,s.style.transform!==i&&(s.style.transform=i)):this.containerReused||a.clearRect(0,0,t,r),this.preRender(a,e),e.viewState),t=i.projection;this.opacity_=n.opacity,this.setupCompositionContext_();let h=!1;return d&&n.extent&&this.clipping&&(r=fromUserExtent(n.extent,t),d=intersectsExtent(r,e.extent),(h=d&&!containsExtent(r,e.extent))&&this.clipUnrotated(this.compositionContext_,e,r)),d&&this.renderWorlds(o,e,!this.getLayer().getDeclutter()&&void 0),h&&this.compositionContext_.restore(),this.releaseCompositionContext_(),this.postRender(a,e),this.renderedRotation_!==i.rotation&&(this.renderedRotation_=i.rotation,this.hitDetectionImageData_=null),this.container}getFeatures(m){return new Promise(e=>{if(!this.hitDetectionImageData_&&!this.animatingOrInteracting_){var t=[this.context.canvas.width,this.context.canvas.height],n=(apply(this.pixelTransform,t),this.renderedCenter_),i=this.renderedResolution_,a=this.renderedRotation_;const c=this.renderedProjection_;var s=this.wrappedRenderedExtent_;const p=this.getLayer(),u=[];var o=t[0]*HIT_DETECT_RESOLUTION,d=t[1]*HIT_DETECT_RESOLUTION;u.push(this.getRenderTransform(n,i,a,HIT_DETECT_RESOLUTION,o,d,0).slice());const g=p.getSource();var h=c.getExtent();if(g.getWrapX()&&c.canWrapX()&&!containsExtent(h,s)){let e=s[0];var l=getWidth(h);let t=0,r;for(;e<h[0];)--t,r=l*t,u.push(this.getRenderTransform(n,i,a,HIT_DETECT_RESOLUTION,o,d,r).slice()),e+=l;for(t=0,e=s[2];e>h[2];)++t,r=l*t,u.push(this.getRenderTransform(n,i,a,HIT_DETECT_RESOLUTION,o,d,r).slice()),e-=l}var r=getUserProjection();this.hitDetectionImageData_=createHitDetectionImageData(t,u,this.renderedFeatures_,p.getStyleFunction(),s,i,a,getSquaredRenderTolerance(i,this.renderedPixelRatio_),r?c:null)}e(hitDetect(m,this.renderedFeatures_,this.hitDetectionImageData_))})}forEachFeatureAtCoordinate(r,n,i,a,s){if(this.replayGroup_){const o=n.viewState.resolution,d=n.viewState.rotation,h=this.getLayer(),l={},c=function(e,t,r){var n=getUid(e);const i=l[n];if(i){if(!0!==i&&r<i.distanceSq){if(0===r)return l[n]=!0,s.splice(s.lastIndexOf(i),1),a(e,h,t);i.geometry=t,i.distanceSq=r}}else{if(0===r)return l[n]=!0,a(e,h,t);s.push(l[n]={feature:e,layer:h,geometry:t,distanceSq:r,callback:a})}};let t;const e=[this.replayGroup_],p=this.getLayer().getDeclutter();return e.some(e=>t=e.forEachFeatureAtCoordinate(r,o,d,i,c,p&&n.declutter[p]?n.declutter[p].all().map(e=>e.value):null)),t}}handleFontsChanged(){const e=this.getLayer();e.getVisible()&&this.replayGroup_&&e.changed()}handleStyleImageChange_(e){this.renderIfReadyAndVisible()}prepareFrame(e){const i=this.getLayer(),r=i.getSource();if(!r)return!1;var t=e.viewHints[ViewHint.ANIMATING],n=e.viewHints[ViewHint.INTERACTING],a=i.getUpdateWhileAnimating(),s=i.getUpdateWhileInteracting();if(this.ready&&!a&&t||!s&&n)return this.animatingOrInteracting_=!0;this.animatingOrInteracting_=!1;a=e.extent;const o=e.viewState,d=o.projection,h=o.resolution;t=e.pixelRatio,s=i.getRevision(),n=i.getRenderBuffer();let l=i.getRenderOrder();void 0===l&&(l=defaultRenderOrder);var c=o.center.slice();const p=buffer(a,n*h);a=p.slice();const u=[p.slice()];var g,n=d.getExtent();if(r.getWrapX()&&d.canWrapX()&&!containsExtent(n,e.extent)&&(C=getWidth(n),g=Math.max(getWidth(p)/2,C),p[0]=n[0]-g,p[2]=n[2]+g,wrapCoordinateX(c,d),(g=wrapExtentX(u[0],d))[0]<n[0]&&g[2]<n[2]?u.push([g[0]+C,g[1],g[2]+C,g[3]]):g[0]>n[0]&&g[2]>n[2]&&u.push([g[0]-C,g[1],g[2]-C,g[3]])),this.ready&&this.renderedResolution_==h&&this.renderedRevision_==s&&this.renderedRenderOrder_==l&&containsExtent(this.wrappedRenderedExtent_,p))return equals(this.renderedExtent_,a)||(this.hitDetectionImageData_=null,this.renderedExtent_=a),this.renderedCenter_=c,!(this.replayGroupChanged=!1);this.replayGroup_=null;const m=new CanvasBuilderGroup(getRenderTolerance(h,t),p,h,t);var _=getUserProjection();let x;if(_){for(let e=0,t=u.length;e<t;++e){const p=u[e],R=toUserExtent(p,d);r.loadFeatures(R,toUserResolution(h,d),_)}x=getTransformFromProjections(_,d)}else for(let e=0,t=u.length;e<t;++e)r.loadFeatures(u[e],h,d);const f=getSquaredRenderTolerance(h,t);let v=!0;var E=(e,t)=>{let r;const n=e.getStyleFunction()||i.getStyleFunction();(r=n?n(e,h):r)&&(e=this.renderFeature(e,f,r,m,x,this.getLayer().getDeclutter(),t),v=v&&!e)};const R=toUserExtent(p,d),y=r.getFeaturesInExtent(R);l&&y.sort(l);for(let e=0,t=y.length;e<t;++e)E(y[e],e);this.renderedFeatures_=y,this.ready=v;var n=m.finish(),C=new ExecutorGroup(p,h,t,r.getOverlaps(),n,i.getRenderBuffer(),!!e.declutter);return this.renderedResolution_=h,this.renderedRevision_=s,this.renderedRenderOrder_=l,this.renderedExtent_=a,this.wrappedRenderedExtent_=p,this.renderedCenter_=c,this.renderedProjection_=d,this.renderedPixelRatio_=t,this.replayGroup_=C,this.hitDetectionImageData_=null,this.replayGroupChanged=!0}renderFeature(r,n,i,a,s,o,d){if(!i)return!1;let h=!1;if(Array.isArray(i))for(let e=0,t=i.length;e<t;++e)h=renderFeature(a,r,i[e],n,this.boundHandleStyleImageChange_,s,o,d)||h;else h=renderFeature(a,r,i,n,this.boundHandleStyleImageChange_,s,o,d);return h}}export default CanvasVectorLayerRenderer;