import CanvasInstruction from"./Instruction.js";import ZIndexContext from"../canvas/ZIndexContext.js";import{TEXT_ALIGN}from"./TextBuilder.js";import{apply as applyTransform,compose as composeTransform,create as createTransform,setFromArray as transformSetFromArray}from"../../transform.js";import{createEmpty,createOrUpdate,intersects}from"../../extent.js";import{defaultPadding,defaultTextAlign,defaultTextBaseline,drawImageOrLabel,getTextDimensions,measureAndCacheTextWidth}from"../canvas.js";import{drawTextOnPath}from"../../geom/flat/textpath.js";import{equals}from"../../array.js";import{lineStringLength}from"../../geom/flat/length.js";import{transform2D}from"../../geom/flat/transform.js";const tmpExtent=createEmpty(),p1=[],p2=[],p3=[],p4=[];function getDeclutterBox(t){return t[3].declutterBox}const rtlRegEx=new RegExp("["+String.fromCharCode(1425)+"-"+String.fromCharCode(2303)+String.fromCharCode(64285)+"-"+String.fromCharCode(65023)+String.fromCharCode(65136)+"-"+String.fromCharCode(65276)+String.fromCharCode(67584)+"-"+String.fromCharCode(69631)+String.fromCharCode(124928)+"-"+String.fromCharCode(126975)+"]");function horizontalTextAlign(t,e){return"start"===e?e=rtlRegEx.test(t)?"right":"left":"end"===e&&(e=rtlRegEx.test(t)?"left":"right"),TEXT_ALIGN[e]}function createTextChunks(t,e,a){return 0<a&&t.push("\n",""),t.push(e,""),t}class Executor{constructor(t,e,a,i,r){this.overlaps=a,this.pixelRatio=e,this.resolution=t,this.alignAndScaleFill_,this.instructions=i.instructions,this.coordinates=i.coordinates,this.coordinateCache_={},this.renderedTransform_=createTransform(),this.hitDetectionInstructions=i.hitDetectionInstructions,this.pixelCoordinates_=null,this.viewRotation_=0,this.fillStates=i.fillStates||{},this.strokeStates=i.strokeStates||{},this.textStates=i.textStates||{},this.widths_={},this.labels_={},this.zIndexContext_=r?new ZIndexContext:null}getZIndexContext(){return this.zIndexContext_}createLabel(a,t,i,r){var e=a+t+i+r;if(this.labels_[e])return this.labels_[e];var s=r?this.strokeStates[r]:null,n=i?this.fillStates[i]:null,l=this.textStates[t],t=this.pixelRatio,t=[l.scale[0]*t,l.scale[1]*t],o=Array.isArray(a),h=l.justify?TEXT_ALIGN[l.justify]:horizontalTextAlign(Array.isArray(a)?a[0]:a,l.textAlign||defaultTextAlign),c=r&&s.lineWidth?s.lineWidth:0,p=o?a:a.split("\n").reduce(createTextChunks,[]),{width:o,height:a,widths:d,heights:u,lineWidths:m}=getTextDimensions(l,p),f=o+c;const x=[];var g,o=(f+2)*t[0],a=(a+c)*t[1],o={width:o<0?Math.floor(o):Math.ceil(o),height:a<0?Math.floor(a):Math.ceil(a),contextInstructions:x},_=(1==t[0]&&1==t[1]||x.push("scale",t),r&&(x.push("strokeStyle",s.strokeStyle),x.push("lineWidth",c),x.push("lineCap",s.lineCap),x.push("lineJoin",s.lineJoin),x.push("miterLimit",s.miterLimit),x.push("setLineDash",[s.lineDash]),x.push("lineDashOffset",s.lineDashOffset)),i&&x.push("fillStyle",n.fillStyle),x.push("textBaseline","middle"),x.push("textAlign","center"),.5-h);let T=h*f+_*c;const C=[],I=[];let v=0,y=0,S=0,b=0,A;for(let t=0,e=p.length;t<e;t+=2){const a=p[t];"\n"===a?(y+=v,v=0,T=h*f+_*c,++b):(g=((g=p[t+1]||l.font)!==A&&(r&&C.push("font",g),i&&I.push("font",g),A=g),v=Math.max(v,u[S]),[a,T+_*d[S]+h*(d[S]-m[b]),.5*(c+v)+y]),T+=d[S],r&&C.push("strokeText",g),i&&I.push("fillText",g),++S)}return Array.prototype.push.apply(x,C),Array.prototype.push.apply(x,I),this.labels_[e]=o}replayTextBackground_(t,e,a,i,r,s,n){t.beginPath(),t.moveTo.apply(t,e),t.lineTo.apply(t,a),t.lineTo.apply(t,i),t.lineTo.apply(t,r),t.lineTo.apply(t,e),s&&(this.alignAndScaleFill_=s[2],this.fill_(t)),n&&(this.setStrokeStyle_(t,n),t.stroke())}calculateImageOrLabelDimensions_(t,e,a,i,r,s,n,l,o,h,c,p,d,u,m,f){let x=a-(n*=p[0]),g=i-(l*=p[1]);n=t<r+o?t-o:r,l=e<s+h?e-h:s,t=u[3]+n*p[0]+u[1],r=u[0]+l*p[1]+u[2],e=x-u[3],s=g-u[0];!m&&0===c||(p1[0]=e,p4[0]=e,p1[1]=s,p2[1]=s,p2[0]=e+t,p3[0]=p2[0],p3[1]=s+r,p4[1]=p3[1]);let _;return 0!==c?(_=composeTransform(createTransform(),a,i,1,1,c,-a,-i),applyTransform(_,p1),applyTransform(_,p2),applyTransform(_,p3),applyTransform(_,p4),createOrUpdate(Math.min(p1[0],p2[0],p3[0],p4[0]),Math.min(p1[1],p2[1],p3[1],p4[1]),Math.max(p1[0],p2[0],p3[0],p4[0]),Math.max(p1[1],p2[1],p3[1],p4[1]),tmpExtent)):createOrUpdate(Math.min(e,e+t),Math.min(s,s+r),Math.max(e,e+t),Math.max(s,s+r),tmpExtent),d&&(x=Math.round(x),g=Math.round(g)),{drawImageX:x,drawImageY:g,drawImageW:n,drawImageH:l,originX:o,originY:h,declutterBox:{minX:tmpExtent[0],minY:tmpExtent[1],maxX:tmpExtent[2],maxY:tmpExtent[3],value:f},canvasTransform:_,scale:p}}replayImageOrLabel_(t,e,a,i,r,s,n){var l=i.declutterBox,o=n?n[2]*i.scale[0]/2:0;return l.minX-o<=e[0]&&0<=l.maxX+o&&l.minY-o<=e[1]&&0<=l.maxY+o&&(!(!s&&!n)&&this.replayTextBackground_(t,p1,p2,p3,p4,s,n),drawImageOrLabel(t,i.canvasTransform,r,a,i.originX,i.originY,i.drawImageW,i.drawImageH,i.drawImageX,i.drawImageY,i.scale)),!0}fill_(t){var e,a,i=this.alignAndScaleFill_;i&&(e=applyTransform(this.renderedTransform_,[0,0]),a=512*this.pixelRatio,t.save(),t.translate(e[0]%a,e[1]%a),1!==i&&t.scale(i,i),t.rotate(this.viewRotation_)),t.fill(),i&&t.restore()}setStrokeStyle_(t,e){t.strokeStyle=e[1],t.lineWidth=e[2],t.lineCap=e[3],t.lineJoin=e[4],t.miterLimit=e[5],t.lineDashOffset=e[7],t.setLineDash(e[6])}drawLabelWithPointPlacement_(t,e,a,i){var r=this.textStates[e],e=this.createLabel(t,e,i,a),i=this.strokeStates[a],a=this.pixelRatio,t=horizontalTextAlign(Array.isArray(t)?t[0]:t,r.textAlign||defaultTextAlign),s=TEXT_ALIGN[r.textBaseline||defaultTextBaseline],i=i&&i.lineWidth?i.lineWidth:0;return{label:e,anchorX:t*(e.width/a-2*r.scale[0])+2*(.5-t)*i,anchorY:s*e.height/a+2*(.5-s)*i}}execute_(h,F,t,e,H,U,Z,c){const q=this.zIndexContext_;let p,d=(this.pixelCoordinates_&&equals(t,this.renderedTransform_)?p=this.pixelCoordinates_:(this.pixelCoordinates_||(this.pixelCoordinates_=[]),p=transform2D(this.coordinates,0,this.coordinates.length,2,t,this.pixelCoordinates_),transformSetFromArray(this.renderedTransform_,t)),0);var a=e.length;let u=0,m,f,x,g,_,T,C,I,v,y,S,b,A,w=0,E=0,J=null,K=null;const V=this.coordinateCache_;var Q=this.viewRotation_,$=Math.round(1e12*Math.atan2(-t[1],t[0]))/1e12;const tt={context:h,pixelRatio:this.pixelRatio,resolution:this.resolution,rotation:Q};var et=this.instructions!=e||this.overlaps?0:200;let L,k,M,at;for(;d<a;){const j=e[d];switch(j[0]){case CanvasInstruction.BEGIN_GEOMETRY:L=j[1],at=j[3],L.getGeometry()?void 0===Z||intersects(Z,at.getExtent())?++d:d=j[2]+1:d=j[2],q&&(q.zIndex=j[4]);break;case CanvasInstruction.BEGIN_PATH:w>et&&(this.fill_(h),w=0),E>et&&(h.stroke(),E=0),w||E||(h.beginPath(),_=NaN,T=NaN),++d;break;case CanvasInstruction.CIRCLE:u=j[1];var O=p[u],R=p[u+1],D=p[u+2]-O,it=p[u+3]-R,D=Math.sqrt(D*D+it*it);h.moveTo(O+D,R),h.arc(O,R,D,0,2*Math.PI,!0),++d;break;case CanvasInstruction.CLOSE_PATH:h.closePath(),++d;break;case CanvasInstruction.CUSTOM:u=j[1],m=j[2];it=j[3];const vt=j[4],yt=j[5],N=(tt.geometry=it,tt.feature=L,d in V||(V[d]=[]),V[d]);yt?yt(p,u,m,2,N):(N[0]=p[u],N[1]=p[u+1],N.length=2),q&&(q.zIndex=j[6]),vt(N,tt),++d;break;case CanvasInstruction.DRAW_IMAGE:u=j[1],m=j[2],v=j[3],f=j[4],x=j[5];let t=j[6];var rt=j[7],st=j[8],nt=j[9],O=j[10];let e=j[11];var lt=j[12];let a=j[13];g=j[14]||"declutter";const G=j[15];!v&&20<=j.length&&(y=j[19],S=j[20],b=j[21],A=j[22],R=this.drawLabelWithPointPlacement_(y,S,b,A),v=R.label,j[3]=v,D=j[23],f=(R.anchorX-D)*this.pixelRatio,j[4]=f,pt=j[24],x=(R.anchorY-pt)*this.pixelRatio,j[5]=x,t=v.height,j[6]=t,a=v.width,j[13]=a);let i;25<j.length&&(i=j[25]);let r,s,n,l=(n=17<j.length?(r=j[16],s=j[17],j[18]):(r=defaultPadding,s=!1),O&&$?e+=Q:O||$||(e-=Q),0);for(;u<m;u+=2)if(!(i&&i[l++]<a/this.pixelRatio)){var ot=this.calculateImageOrLabelDimensions_(v.width,v.height,p[u],p[u+1],a,t,f,x,st,nt,e,lt,H,r,s||n,L),ht=[h,F,v,ot,rt,s?J:null,n?K:null];if(c){let t,e,a;if(G){var ct=m-u;if(!G[ct]){G[ct]={args:ht,declutterMode:g};continue}var B=G[ct];t=B.args,e=B.declutterMode,delete G[ct],a=getDeclutterBox(t)}let i,r;!t||"declutter"===e&&c.collides(a)||(i=!0),"declutter"===g&&c.collides(ot.declutterBox)||(r=!0),"declutter"===e&&"declutter"===g&&(B=i&&r,i=B,r=B),i&&("none"!==e&&c.insert(a),this.replayImageOrLabel_.apply(this,t)),r&&("none"!==g&&c.insert(ot.declutterBox),this.replayImageOrLabel_.apply(this,ht))}else this.replayImageOrLabel_.apply(this,ht)}++d;break;case CanvasInstruction.DRAW_CHARS:var pt=j[1],dt=j[2],ut=j[3],mt=j[4],ft=(A=j[5],j[6]),P=j[7],xt=j[8],gt=(b=j[9],j[10]),_t=(y=j[11],S=j[12],[j[13],j[13]]),W=(g=j[14]||"declutter",this.textStates[S]),X=W.font,Y=[W.scale[0]*P,W.scale[1]*P];let o;X in this.widths_?o=this.widths_[X]:(o={},this.widths_[X]=o);W=lineStringLength(p,pt,dt,2),P=Math.abs(Y[0])*measureAndCacheTextWidth(X,y,o);if(mt||P<=W){var mt=this.textStates[S].textAlign,W=(W-P)*horizontalTextAlign(y,mt),Tt=drawTextOnPath(p,pt,dt,2,y,W,ft,Math.abs(Y[0]),measureAndCacheTextWidth,X,o,$?0:this.viewRotation_);t:if(Tt){const z=[];let t,e,a,i,r;if(b)for(t=0,e=Tt.length;t<e;++t){r=Tt[t],a=r[4],i=this.createLabel(a,S,"",b),f=r[2]+(Y[0]<0?-gt:gt),x=ut*i.height+2*(.5-ut)*gt*Y[1]/Y[0]-xt;var Ct=this.calculateImageOrLabelDimensions_(i.width,i.height,r[0],r[1],i.width,i.height,f,x,0,0,r[3],_t,!1,defaultPadding,!1,L);if(c&&"declutter"===g&&c.collides(Ct.declutterBox))break t;z.push([h,F,i,Ct,1,null,null])}if(A)for(t=0,e=Tt.length;t<e;++t){r=Tt[t],a=r[4],i=this.createLabel(a,S,A,""),f=r[2],x=ut*i.height-xt;var It=this.calculateImageOrLabelDimensions_(i.width,i.height,r[0],r[1],i.width,i.height,f,x,0,0,r[3],_t,!1,defaultPadding,!1,L);if(c&&"declutter"===g&&c.collides(It.declutterBox))break t;z.push([h,F,i,It,1,null,null])}c&&"none"!==g&&c.load(z.map(getDeclutterBox));for(let t=0,e=z.length;t<e;++t)this.replayImageOrLabel_.apply(this,z[t])}}++d;break;case CanvasInstruction.END_GEOMETRY:if(void 0!==U){P=U(L=j[1],at);if(P)return P}++d;break;case CanvasInstruction.FILL:et?w++:this.fill_(h),++d;break;case CanvasInstruction.MOVE_TO_LINE_TO:for(u=j[1],m=j[2],k=p[u],M=p[u+1],C=k+.5|0,I=M+.5|0,C===_&&I===T||(h.moveTo(k,M),_=C,T=I),u+=2;u<m;u+=2)k=p[u],M=p[u+1],C=k+.5|0,I=M+.5|0,u!=m-2&&C===_&&I===T||(h.lineTo(k,M),_=C,T=I);++d;break;case CanvasInstruction.SET_FILL_STYLE:J=j,this.alignAndScaleFill_=j[2],w&&(this.fill_(h),w=0,E&&(h.stroke(),E=0)),h.fillStyle=j[1],++d;break;case CanvasInstruction.SET_STROKE_STYLE:K=j,E&&(h.stroke(),E=0),this.setStrokeStyle_(h,j),++d;break;case CanvasInstruction.STROKE:et?E++:h.stroke(),++d;break;default:++d}}w&&this.fill_(h),E&&h.stroke()}execute(t,e,a,i,r,s){this.viewRotation_=i,this.execute_(t,e,a,this.instructions,r,void 0,void 0,s)}executeHitDetection(t,e,a,i,r){return this.viewRotation_=a,this.execute_(t,[t.canvas.width,t.canvas.height],e,this.hitDetectionInstructions,!0,i,r)}}export default Executor;