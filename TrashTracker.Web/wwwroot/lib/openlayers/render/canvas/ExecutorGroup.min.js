import Executor from"./Executor.js";import{ascending}from"../../array.js";import{buffer,createEmpty,extendCoordinate}from"../../extent.js";import{compose as composeTransform,create as createTransform}from"../../transform.js";import{createCanvasContext2D}from"../../dom.js";import{isEmpty}from"../../obj.js";import{transform2D}from"../../geom/flat/transform.js";const ALL=["Polygon","Circle","LineString","Image","Text","Default"],DECLUTTER=["Image","Text"],NON_DECLUTTER=ALL.filter(e=>!DECLUTTER.includes(e));class ExecutorGroup{constructor(e,t,r,n,o,s,i){this.maxExtent_=e,this.overlaps_=n,this.pixelRatio_=r,this.resolution_=t,this.renderBuffer_=s,this.executorsByZIndex_={},this.hitDetectionContext_=null,this.hitDetectionTransform_=createTransform(),this.renderedContext_=null,this.deferredZIndexContexts_=[],this.createExecutors_(o,i)}clip(e,t){t=this.getClipCoords(t);e.beginPath(),e.moveTo(t[0],t[1]),e.lineTo(t[2],t[3]),e.lineTo(t[4],t[5]),e.lineTo(t[6],t[7]),e.clip()}createExecutors_(t,r){for(const s in t){let e=this.executorsByZIndex_[s];void 0===e&&(e={},this.executorsByZIndex_[s]=e);var n=t[s];for(const i in n){var o=n[i];e[i]=new Executor(this.resolution_,this.pixelRatio_,this.overlaps_,o,r)}}}hasExecutors(r){for(const e in this.executorsByZIndex_){var n=this.executorsByZIndex_[e];for(let e=0,t=r.length;e<t;++e)if(r[e]in n)return!0}return!1}forEachFeatureAtCoordinate(e,t,r,a,c,x){const d=2*(a=Math.round(a))+1;var n=composeTransform(this.hitDetectionTransform_,a+.5,a+.5,1/t,-1/t,-r,-e[0],-e[1]),o=!this.hitDetectionContext_;o&&(this.hitDetectionContext_=createCanvasContext2D(d,d,void 0,{willReadFrequently:!0}));const h=this.hitDetectionContext_;h.canvas.width!==d||h.canvas.height!==d?(h.canvas.width=d,h.canvas.height=d):o||h.clearRect(0,0,d,d);let s;void 0!==this.renderBuffer_&&(s=createEmpty(),extendCoordinate(s,e),buffer(s,t*(this.renderBuffer_+a),s));const f=getPixelIndexArray(a);let l;function i(r,n){var o=h.getImageData(0,0,d,d).data;for(let e=0,t=f.length;e<t;e++)if(0<o[f[e]]){if(!x||"Image"!==l&&"Text"!==l||x.includes(r)){var s=(f[e]-3)/4,i=a-s%d,s=a-(s/d|0),i=c(r,n,i*i+s*s);if(i)return i}h.clearRect(0,0,d,d);break}}const u=Object.keys(this.executorsByZIndex_).map(Number);u.sort(ascending);let m,_,C,p,g;for(m=u.length-1;0<=m;--m){var v=u[m].toString();for(C=this.executorsByZIndex_[v],_=ALL.length-1;0<=_;--_)if(l=ALL[_],void 0!==(p=C[l])&&(g=p.executeHitDetection(h,n,r,i,s)))return g}}getClipCoords(e){var t=this.maxExtent_;if(!t)return null;var r=t[0],n=t[1],o=t[2],t=t[3],r=[r,n,r,t,o,t,o,n];return transform2D(r,0,8,2,e,r),r}isEmpty(){return isEmpty(this.executorsByZIndex_)}execute(e,t,r,n,o,s,i){const a=Object.keys(this.executorsByZIndex_).map(Number);a.sort(ascending),s=s||ALL;let c,x,d,h,f,l;for(i&&a.reverse(),c=0,x=a.length;c<x;++c){var u=a[c].toString();for(f=this.executorsByZIndex_[u],d=0,h=s.length;d<h;++d){var m=s[d];if(void 0!==(l=f[m])){const _=null===i?void 0:l.getZIndexContext(),C=_?_.getContext():e;var m=this.maxExtent_&&"Image"!==m&&"Text"!==m;m&&(C.save(),this.clip(C,r)),l.execute(C,t,r,n,o,i),m&&C.restore(),_&&(_.offset(),m=a[c],this.deferredZIndexContexts_[m]||(this.deferredZIndexContexts_[m]=[]),this.deferredZIndexContexts_[m].push(_))}}}this.renderedContext_=e}getDeferredZIndexContexts(){return this.deferredZIndexContexts_}getRenderedContext(){return this.renderedContext_}renderDeferred(){this.deferredZIndexContexts_.forEach(e=>{e.forEach(e=>{e.draw(this.renderedContext_),e.clear()})})}}const circlePixelIndexArrayCache={};function getPixelIndexArray(n){if(void 0!==circlePixelIndexArrayCache[n])return circlePixelIndexArrayCache[n];var o=2*n+1,s=n*n;const i=new Array(1+s);for(let r=0;r<=n;++r)for(let t=0;t<=n;++t){var a=r*r+t*t;if(s<a)break;let e=i[a];e||(e=[],i[a]=e),e.push(4*((n+r)*o+(n+t))+3),0<r&&e.push(4*((n-r)*o+(n+t))+3),0<t&&(e.push(4*((n+r)*o+(n-t))+3),0<r&&e.push(4*((n-r)*o+(n-t))+3))}const r=[];for(let e=0,t=i.length;e<t;++e)i[e]&&r.push(...i[e]);return circlePixelIndexArrayCache[n]=r}export default ExecutorGroup;export{ALL,DECLUTTER,NON_DECLUTTER,getPixelIndexArray};