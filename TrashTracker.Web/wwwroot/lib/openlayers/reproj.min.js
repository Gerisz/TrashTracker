import{containsCoordinate,createEmpty,extend,forEachCorner,getCenter,getHeight,getTopLeft,getWidth}from"./extent.js";import{createCanvasContext2D,releaseCanvas}from"./dom.js";import{getPointResolution,transform}from"./proj.js";import{solveLinearSystem}from"./math.js";let brokenDiagonalRendering_;const canvasPool=[];function drawTestTriangle(e,t,n,o,a){e.beginPath(),e.moveTo(0,0),e.lineTo(t,n),e.lineTo(o,a),e.closePath(),e.save(),e.clip(),e.fillRect(0,0,Math.max(t,o)+1,Math.max(n,a)),e.restore()}function verifyBrokenDiagonalRendering(e,t){return 2<Math.abs(e[4*t]-210)||2<Math.abs(e[4*t+3]-191.25)}function isBrokenDiagonalRendering(){if(void 0===brokenDiagonalRendering_){const t=createCanvasContext2D(6,6,canvasPool);t.globalCompositeOperation="lighter",t.fillStyle="rgba(210, 0, 0, 0.75)",drawTestTriangle(t,4,5,4,0),drawTestTriangle(t,4,5,0,5);var e=t.getImageData(0,0,3,3).data;brokenDiagonalRendering_=verifyBrokenDiagonalRendering(e,0)||verifyBrokenDiagonalRendering(e,4)||verifyBrokenDiagonalRendering(e,8),releaseCanvas(t),canvasPool.push(t.canvas)}return brokenDiagonalRendering_}function calculateSourceResolution(e,t,n,o){var a=transform(n,t,e);let r=getPointResolution(t,o,n);var o=t.getMetersPerUnit(),n=(void 0!==o&&(r*=o),e.getMetersPerUnit()),t=(void 0!==n&&(r/=n),e.getExtent());return t&&!containsCoordinate(t,a)||(o=getPointResolution(e,r,a)/r,isFinite(o)&&0<o&&(r/=o)),r}function calculateSourceExtentResolution(t,n,e,o){var a=getCenter(e);let r=calculateSourceResolution(t,n,a,o);return(!isFinite(r)||r<=0)&&forEachCorner(e,function(e){return r=calculateSourceResolution(t,n,e,o),isFinite(r)&&0<r}),r}function render(e,t,n,o,a,T,r,i,p,l,s,C,g,c){const R=createCanvasContext2D(Math.round(n*e),Math.round(n*t),canvasPool);if(C||(R.imageSmoothingEnabled=!1),0===p.length)return R.canvas;function x(e){return Math.round(e*n)/n}R.scale(n,n),R.globalCompositeOperation="lighter";const M=createEmpty();p.forEach(function(e,t,n){extend(M,e.extent)});let P;const h=n/o,b=(C?1:1+Math.pow(2,-24))/h;if(!g||1!==p.length||0!==l){if(P=createCanvasContext2D(Math.round(getWidth(M)*h),Math.round(getHeight(M)*h),canvasPool),C||(P.imageSmoothingEnabled=!1),a&&c){o=(a[0]-M[0])*h,g=-(a[3]-M[3])*h;const e=getWidth(a)*h,t=getHeight(a)*h;P.rect(o,g,e,t),P.clip()}p.forEach(function(e,t,n){var o=(e.extent[0]-M[0])*h,a=-(e.extent[3]-M[3])*h,r=getWidth(e.extent)*h,i=getHeight(e.extent)*h;0<e.image.width&&0<e.image.height&&P.drawImage(e.image,l,l,e.image.width-2*l,e.image.height-2*l,C?o:Math.round(o),C?a:Math.round(a),C?r:Math.round(o+r)-Math.round(o),C?i:Math.round(a+i)-Math.round(a))})}const D=getTopLeft(r);return i.getTriangles().forEach(function(t,e,n){const o=t.source;var t=t.target,a=o[0][0],r=o[0][1],i=o[1][0],l=o[1][1],s=o[2][0],g=o[2][1],c=x((t[0][0]-D[0])/T),h=x(-(t[0][1]-D[1])/T),u=x((t[1][0]-D[0])/T),d=x(-(t[1][1]-D[1])/T),v=x((t[2][0]-D[0])/T),t=x(-(t[2][1]-D[1])/T),i=[[i-=a,l-=r,0,0,u-c],[s-=a,g-=r,0,0,v-c],[0,0,i,l,d-h],[0,0,s,g,t-h]],l=solveLinearSystem(i);if(l){if(R.save(),R.beginPath(),isBrokenDiagonalRendering()||!C){R.moveTo(u,d);var f=c-u,m=h-d;for(let e=0;e<4;e++)R.lineTo(u+x((e+1)*f/4),d+x(e*m/3)),3!=e&&R.lineTo(u+x((e+1)*f/4),d+x((e+1)*m/3));R.lineTo(v,t)}else R.moveTo(u,d),R.lineTo(c,h),R.lineTo(v,t);R.clip(),R.transform(l[0],l[2],l[1],l[3],c,h),R.translate(M[0]-a,M[3]-r);let e;if(P)e=P.canvas,R.scale(b,-b);else{const o=p[0];s=o.extent;e=o.image,R.scale(getWidth(s)/e.width,-getHeight(s)/e.height)}R.drawImage(e,0,0),R.restore()}}),P&&(releaseCanvas(P),canvasPool.push(P.canvas)),s&&(R.save(),R.globalCompositeOperation="source-over",R.strokeStyle="black",R.lineWidth=1,i.getTriangles().forEach(function(e,t,n){var e=e.target,o=(e[0][0]-D[0])/T,a=-(e[0][1]-D[1])/T,r=(e[1][0]-D[0])/T,i=-(e[1][1]-D[1])/T,l=(e[2][0]-D[0])/T,e=-(e[2][1]-D[1])/T;R.beginPath(),R.moveTo(r,i),R.lineTo(o,a),R.lineTo(l,e),R.closePath(),R.stroke()}),R.restore()),R.canvas}export{canvasPool,calculateSourceResolution,calculateSourceExtentResolution,render};